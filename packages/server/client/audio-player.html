<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³é¢‘æ’­æ”¾å™¨ - Agent Edge</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            min-width: 300px;
            max-width: 500px;
            width: 100%;
        }
        h1 {
            font-size: 20px;
            margin-bottom: 16px;
            color: #fff;
        }
        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            padding: 12px;
            background: #1a1a1a;
            border-radius: 8px;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
            animation: pulse 2s infinite;
        }
        .status-dot.connected {
            background: #4caf50;
        }
        .status-dot.playing {
            background: #ff9800;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .status-text {
            flex: 1;
        }
        .info {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }
        .hidden {
            display: none;
        }
        .enable-audio-btn {
            margin-top: 20px;
            padding: 12px 24px;
            font-size: 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .enable-audio-btn:hover {
            background: #45a049;
        }
        .enable-audio-btn:active {
            background: #3d8b40;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ éŸ³é¢‘æ’­æ”¾å™¨</h1>
        <div class="status">
            <div class="status-dot" id="statusDot"></div>
            <div class="status-text" id="statusText">æ­£åœ¨è¿æ¥...</div>
        </div>
        <div class="info" id="info">ç­‰å¾…éŸ³é¢‘æ•°æ®...</div>
        <button id="enableAudioBtn" class="enable-audio-btn hidden" onclick="enableAudioPlayback()">ğŸ”Š ç‚¹å‡»å¯ç”¨éŸ³é¢‘æ’­æ”¾</button>
    </div>

    <script>
        // æµå¼æ’­æ”¾ç›¸å…³å˜é‡
        let audioContext = null;
        let audioQueue = [];
        let isPlaying = false;
        let ws = null;
        let chunksReceived = 0;
        let bytesReceived = 0;
        let audioEnabled = false; // ç”¨æˆ·æ˜¯å¦å·²å¯ç”¨éŸ³é¢‘
        const sampleRate = 24000;

        // æ›´æ–°çŠ¶æ€
        function updateStatus(text, className) {
            const statusText = document.getElementById('statusText');
            const statusDot = document.getElementById('statusDot');
            const info = document.getElementById('info');
            
            statusText.textContent = text;
            statusDot.className = 'status-dot ' + (className || '');
            
            if (chunksReceived > 0) {
                info.textContent = `å·²æ¥æ”¶ ${chunksReceived} ä¸ªéŸ³é¢‘å—ï¼Œå…± ${(bytesReceived / 1024).toFixed(1)} KB`;
            }
        }

        // åˆå§‹åŒ–éŸ³é¢‘æ’­æ”¾
        function initAudio() {
            try {
                // å¦‚æœ AudioContext å·²å­˜åœ¨ä¸”æœªå…³é—­ï¼Œé‡ç”¨
                if (audioContext && audioContext.state !== 'closed') {
                    console.log('[éŸ³é¢‘æ’­æ”¾å™¨] å¤ç”¨ç°æœ‰ AudioContextï¼ŒçŠ¶æ€:', audioContext.state);
                    // å¦‚æœé‡ç”¨çš„ AudioContext æ˜¯ suspendedï¼Œç¡®ä¿æŒ‰é’®æ˜¾ç¤º
                    if (audioContext.state === 'suspended' && !audioEnabled) {
                        const btn = document.getElementById('enableAudioBtn');
                        if (btn) {
                            btn.classList.remove('hidden');
                        }
                        updateStatus('å·²å°±ç»ªï¼ˆéœ€è¦å¯ç”¨éŸ³é¢‘ï¼‰', 'connected');
                    }
                    return;
                }
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate });
                audioQueue = [];
                isPlaying = false;
                audioEnabled = false; // é‡ç½®å¯ç”¨çŠ¶æ€ï¼Œç¡®ä¿éœ€è¦ç”¨æˆ·äº¤äº’
                console.log('[éŸ³é¢‘æ’­æ”¾å™¨] AudioContext å·²åˆ›å»ºï¼Œé‡‡æ ·ç‡:', audioContext.sampleRate, 'çŠ¶æ€:', audioContext.state);
                
                // æ— è®ºçŠ¶æ€å¦‚ä½•ï¼Œéƒ½æ˜¾ç¤ºå¯ç”¨æŒ‰é’®ï¼ˆç¡®ä¿ç”¨æˆ·å¿…é¡»ç‚¹å‡»ï¼‰
                const btn = document.getElementById('enableAudioBtn');
                if (btn) {
                    btn.classList.remove('hidden');
                }
                
                // æ ¹æ®çŠ¶æ€æ›´æ–°æç¤º
                if (audioContext.state === 'suspended') {
                    console.warn('[éŸ³é¢‘æ’­æ”¾å™¨] AudioContext å¤„äº suspended çŠ¶æ€ï¼Œéœ€è¦ç”¨æˆ·äº¤äº’');
                    updateStatus('å·²å°±ç»ªï¼ˆéœ€è¦å¯ç”¨éŸ³é¢‘ï¼‰', 'connected');
                } else {
                    // å³ä½¿ä¸æ˜¯ suspendedï¼Œä¹Ÿè¦æ±‚ç”¨æˆ·ç‚¹å‡»æŒ‰é’®ä»¥ç¡®ä¿é€šè¿‡ç”¨æˆ·äº¤äº’å¯ç”¨
                    updateStatus('å·²å°±ç»ªï¼ˆè¯·ç‚¹å‡»æŒ‰é’®å¯ç”¨éŸ³é¢‘ï¼‰', 'connected');
                }
            } catch (err) {
                console.error('[éŸ³é¢‘æ’­æ”¾å™¨] åˆå§‹åŒ–éŸ³é¢‘å¤±è´¥:', err);
                updateStatus('éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥', '');
            }
        }

        // æ’­æ”¾éŸ³é¢‘åˆ†ç‰‡
        function playAudioChunk(base64Data) {
            if (!audioContext) {
                console.error('[éŸ³é¢‘æ’­æ”¾å™¨] AudioContext æœªåˆå§‹åŒ–');
                return;
            }

            if (!base64Data || base64Data.length === 0) {
                console.warn('[éŸ³é¢‘æ’­æ”¾å™¨] éŸ³é¢‘æ•°æ®ä¸ºç©º');
                return;
            }

            try {
                // è§£ç  base64
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }

                // ç¡®ä¿å­—èŠ‚æ•°æ˜¯å¶æ•°ï¼ˆPCM16éœ€è¦2å­—èŠ‚å¯¹é½ï¼‰
                const alignedLength = bytes.length - (bytes.length % 2);
                if (alignedLength === 0) {
                    console.warn('[éŸ³é¢‘æ’­æ”¾å™¨] éŸ³é¢‘æ•°æ®å¤ªå°ï¼Œè·³è¿‡');
                    return;
                }
                const alignedBytes = bytes.slice(0, alignedLength);

                // è½¬æ¢ä¸º Int16Array (PCM16, å°ç«¯åº)
                const pcmData = new Int16Array(alignedBytes.buffer, alignedBytes.byteOffset, alignedBytes.length / 2);
                
                // è½¬æ¢ä¸º Float32Array (-1.0 åˆ° 1.0)
                const floatData = new Float32Array(pcmData.length);
                for (let i = 0; i < pcmData.length; i++) {
                    floatData[i] = pcmData[i] / 32768.0;
                }

                chunksReceived++;
                bytesReceived += alignedBytes.length;

                // æ·»åŠ åˆ°é˜Ÿåˆ—
                audioQueue.push(floatData);
                console.log('[éŸ³é¢‘æ’­æ”¾å™¨] éŸ³é¢‘åˆ†ç‰‡å·²åŠ å…¥é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é•¿åº¦:', audioQueue.length, 'æ ·æœ¬æ•°:', floatData.length);

                // å¦‚æœè¿˜æ²¡å¼€å§‹æ’­æ”¾ä¸”éŸ³é¢‘å·²å¯ç”¨ï¼Œç«‹å³å¼€å§‹
                if (!isPlaying && audioEnabled) {
                    startPlayback();
                } else if (!audioEnabled) {
                    console.log('[éŸ³é¢‘æ’­æ”¾å™¨] éŸ³é¢‘æœªå¯ç”¨ï¼Œç­‰å¾…ç”¨æˆ·äº¤äº’');
                }
            } catch (err) {
                console.error('[éŸ³é¢‘æ’­æ”¾å™¨] å¤„ç†éŸ³é¢‘åˆ†ç‰‡å¤±è´¥:', err);
            }
        }

        // å¼€å§‹æ’­æ”¾
        function startPlayback() {
            if (!audioContext) {
                console.warn('[éŸ³é¢‘æ’­æ”¾å™¨] AudioContext ä¸å­˜åœ¨ï¼Œæ— æ³•æ’­æ”¾');
                return;
            }
            
            // æ£€æŸ¥ AudioContext çŠ¶æ€
            if (audioContext.state === 'suspended') {
                console.warn('[éŸ³é¢‘æ’­æ”¾å™¨] AudioContext å¤„äº suspended çŠ¶æ€ï¼Œéœ€è¦å…ˆå¯ç”¨éŸ³é¢‘');
                if (!audioEnabled) {
                    const btn = document.getElementById('enableAudioBtn');
                    if (btn) {
                        btn.classList.remove('hidden');
                    }
                }
                return;
            }
            
            // ç¡®ä¿éŸ³é¢‘å·²å¯ç”¨
            if (!audioEnabled) {
                console.warn('[éŸ³é¢‘æ’­æ”¾å™¨] éŸ³é¢‘æœªå¯ç”¨ï¼Œæ— æ³•æ’­æ”¾');
                return;
            }
            
            if (audioContext.state === 'closed') {
                console.error('[éŸ³é¢‘æ’­æ”¾å™¨] AudioContext å·²å…³é—­ï¼Œé‡æ–°åˆå§‹åŒ–');
                initAudio();
                return;
            }
            
            if (isPlaying) {
                console.log('[éŸ³é¢‘æ’­æ”¾å™¨] å·²åœ¨æ’­æ”¾ä¸­ï¼Œè·³è¿‡');
                return;
            }

            isPlaying = true;
            updateStatus('æ­£åœ¨æ’­æ”¾', 'playing');
            console.log('[éŸ³é¢‘æ’­æ”¾å™¨] å¼€å§‹æ’­æ”¾ï¼Œé˜Ÿåˆ—é•¿åº¦:', audioQueue.length, 'AudioContext çŠ¶æ€:', audioContext.state);

            const playNext = () => {
                if (!audioContext) {
                    console.warn('[éŸ³é¢‘æ’­æ”¾å™¨] AudioContext ä¸å­˜åœ¨ï¼Œåœæ­¢æ’­æ”¾');
                    isPlaying = false;
                    return;
                }
                
                // æ£€æŸ¥ AudioContext çŠ¶æ€
                if (audioContext.state === 'closed') {
                    console.warn('[éŸ³é¢‘æ’­æ”¾å™¨] AudioContext å·²å…³é—­ï¼Œåœæ­¢æ’­æ”¾');
                    isPlaying = false;
                    return;
                }
                
                if (audioContext.state === 'suspended') {
                    console.warn('[éŸ³é¢‘æ’­æ”¾å™¨] AudioContext å¤„äº suspended çŠ¶æ€');
                    isPlaying = false;
                    return;
                }
                
                if (audioQueue.length === 0) {
                    // é˜Ÿåˆ—ä¸ºç©ºï¼Œç­‰å¾…æ›´å¤šæ•°æ®ï¼ˆä½†ä¸è¦å¤ªé¢‘ç¹æ£€æŸ¥ï¼‰
                    setTimeout(playNext, 50);
                    return;
                }

                const chunk = audioQueue.shift();
                if (!chunk || chunk.length === 0) {
                    console.warn('[éŸ³é¢‘æ’­æ”¾å™¨] é˜Ÿåˆ—ä¸­çš„åˆ†ç‰‡ä¸ºç©ºï¼Œè·³è¿‡');
                    setTimeout(playNext, 0);
                    return;
                }
                // åˆ›å»º AudioBuffer
                const buffer = audioContext.createBuffer(1, chunk.length, sampleRate);
                buffer.getChannelData(0).set(chunk);

                // åˆ›å»ºå¹¶æ’­æ”¾
                const source = audioContext.createBufferSource();
                source.buffer = buffer;
                source.connect(audioContext.destination);

                source.onended = () => {
                    setTimeout(playNext, 0);
                };

                source.onerror = (err) => {
                    console.error('[éŸ³é¢‘æ’­æ”¾å™¨] æ’­æ”¾æºé”™è¯¯:', err);
                    isPlaying = false;
                };

                try {
                    source.start(0);
                    console.log('[éŸ³é¢‘æ’­æ”¾å™¨] æ­£åœ¨æ’­æ”¾åˆ†ç‰‡ï¼Œæ ·æœ¬æ•°:', chunk.length, 'å‰©ä½™é˜Ÿåˆ—:', audioQueue.length);
                } catch (err) {
                    console.error('[éŸ³é¢‘æ’­æ”¾å™¨] æ’­æ”¾åˆ†ç‰‡å¤±è´¥:', err);
                    // ç»§ç»­æ’­æ”¾ä¸‹ä¸€ä¸ª
                    setTimeout(playNext, 0);
                }
            };

            playNext();
        }

        // å¯ç”¨éŸ³é¢‘æ’­æ”¾ï¼ˆç”¨æˆ·äº¤äº’ï¼‰
        function enableAudioPlayback() {
            if (!audioContext) {
                console.error('[éŸ³é¢‘æ’­æ”¾å™¨] AudioContext ä¸å­˜åœ¨');
                return;
            }
            
            // æ— è®ºçŠ¶æ€å¦‚ä½•ï¼Œéƒ½å°è¯•æ¢å¤ AudioContextï¼ˆç¡®ä¿éŸ³é¢‘çœŸæ­£å¯ç”¨ï¼‰
            if (audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    console.log('[éŸ³é¢‘æ’­æ”¾å™¨] AudioContext å·²æ¢å¤ï¼ŒçŠ¶æ€:', audioContext.state);
                    audioEnabled = true;
                    const btn = document.getElementById('enableAudioBtn');
                    if (btn) {
                        btn.classList.add('hidden');
                    }
                    updateStatus('å·²å°±ç»ª', 'connected');
                    
                    // å¦‚æœé˜Ÿåˆ—ä¸­æœ‰æ•°æ®ï¼Œç«‹å³å¼€å§‹æ’­æ”¾
                    if (audioQueue.length > 0 && !isPlaying) {
                        console.log('[éŸ³é¢‘æ’­æ”¾å™¨] é˜Ÿåˆ—ä¸­æœ‰æ•°æ®ï¼Œå¼€å§‹æ’­æ”¾');
                        startPlayback();
                    }
                }).catch(err => {
                    console.error('[éŸ³é¢‘æ’­æ”¾å™¨] æ¢å¤ AudioContext å¤±è´¥:', err);
                    updateStatus('å¯ç”¨éŸ³é¢‘å¤±è´¥', '');
                });
            } else {
                // å¦‚æœå·²ç»æ˜¯ running çŠ¶æ€ï¼Œä¹Ÿéœ€è¦ç¡®ä¿éŸ³é¢‘çœŸæ­£å¯ç”¨
                // å°è¯• resume ä»¥ç¡®ä¿ï¼ˆå³ä½¿çŠ¶æ€ä¸æ˜¯ suspendedï¼Œresume ä¹Ÿä¸ä¼šæŠ¥é”™ï¼‰
                audioContext.resume().then(() => {
                    console.log('[éŸ³é¢‘æ’­æ”¾å™¨] AudioContext å·²ç¡®è®¤ï¼ŒçŠ¶æ€:', audioContext.state);
                    audioEnabled = true;
                    const btn = document.getElementById('enableAudioBtn');
                    if (btn) {
                        btn.classList.add('hidden');
                    }
                    updateStatus('å·²å°±ç»ª', 'connected');
                    
                    // å¦‚æœé˜Ÿåˆ—ä¸­æœ‰æ•°æ®ï¼Œç«‹å³å¼€å§‹æ’­æ”¾
                    if (audioQueue.length > 0 && !isPlaying) {
                        console.log('[éŸ³é¢‘æ’­æ”¾å™¨] é˜Ÿåˆ—ä¸­æœ‰æ•°æ®ï¼Œå¼€å§‹æ’­æ”¾');
                        startPlayback();
                    }
                }).catch(err => {
                    console.error('[éŸ³é¢‘æ’­æ”¾å™¨] ç¡®è®¤ AudioContext å¤±è´¥:', err);
                    // å³ä½¿å¤±è´¥ï¼Œä¹Ÿå°è¯•è®¾ç½®æ ‡å¿—
                    audioEnabled = true;
                    const btn = document.getElementById('enableAudioBtn');
                    if (btn) {
                        btn.classList.add('hidden');
                    }
                    updateStatus('å·²å°±ç»ª', 'connected');
                });
            }
        }

        // å®Œæˆæ’­æ”¾
        function finalizePlayback() {
            updateStatus('æ’­æ”¾å®Œæˆ', 'connected');
            
            // ç­‰å¾…é˜Ÿåˆ—æ¸…ç©º
            const checkQueue = setInterval(() => {
                if (audioQueue.length === 0 && isPlaying) {
                    setTimeout(() => {
                        if (audioContext) {
                            audioContext.close().catch(() => {});
                        }
                        audioContext = null;
                        isPlaying = false;
                        audioQueue = [];
                        chunksReceived = 0;
                        bytesReceived = 0;
                        updateStatus('å·²å°±ç»ª', 'connected');
                        initAudio(); // é‡æ–°åˆå§‹åŒ–ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡æ’­æ”¾
                    }, 500);
                    clearInterval(checkQueue);
                }
            }, 100);
        }

        // è¿æ¥ WebSocket
        function connectWebSocket() {
            // client æ¨¡å¼ä¸‹ä½¿ç”¨å½“å‰é¡µé¢çš„ WebSocketï¼ˆåŒæºï¼‰
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/audio-ws`;
            console.log('[éŸ³é¢‘æ’­æ”¾å™¨] è¿æ¥ WebSocket:', wsUrl);
            
            updateStatus('æ­£åœ¨è¿æ¥...', '');
            
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('[éŸ³é¢‘æ’­æ”¾å™¨] WebSocket å·²è¿æ¥');
                updateStatus('å·²è¿æ¥', 'connected');
                initAudio();
                
                // å‘é€å°±ç»ªæ¶ˆæ¯
                try {
                    ws.send(JSON.stringify({ type: 'ready' }));
                } catch (err) {
                    console.error('[éŸ³é¢‘æ’­æ”¾å™¨] å‘é€å°±ç»ªæ¶ˆæ¯å¤±è´¥:', err);
                }
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('[éŸ³é¢‘æ’­æ”¾å™¨] æ”¶åˆ°æ¶ˆæ¯:', data.type);
                    if (data.type === 'audio_chunk') {
                        if (data.chunk) {
                            console.log('[éŸ³é¢‘æ’­æ”¾å™¨] æ”¶åˆ°éŸ³é¢‘åˆ†ç‰‡ï¼Œå¤§å°:', data.chunk.length);
                            playAudioChunk(data.chunk);
                        } else {
                            console.warn('[éŸ³é¢‘æ’­æ”¾å™¨] éŸ³é¢‘åˆ†ç‰‡ä¸ºç©º');
                        }
                    } else if (data.type === 'done') {
                        console.log('[éŸ³é¢‘æ’­æ”¾å™¨] æ”¶åˆ°æ’­æ”¾å®Œæˆä¿¡å·');
                        finalizePlayback();
                    } else {
                        console.log('[éŸ³é¢‘æ’­æ”¾å™¨] æœªçŸ¥æ¶ˆæ¯ç±»å‹:', data.type);
                    }
                } catch (err) {
                    console.error('[éŸ³é¢‘æ’­æ”¾å™¨] å¤„ç†æ¶ˆæ¯å¤±è´¥:', err);
                }
            };

            ws.onerror = (err) => {
                console.error('[éŸ³é¢‘æ’­æ”¾å™¨] WebSocket é”™è¯¯:', err);
                updateStatus('è¿æ¥é”™è¯¯', '');
            };

            ws.onclose = () => {
                console.log('[éŸ³é¢‘æ’­æ”¾å™¨] WebSocket å·²æ–­å¼€');
                updateStatus('å·²æ–­å¼€ï¼Œæ­£åœ¨é‡è¿...', '');
                setTimeout(connectWebSocket, 3000);
            };
        }

        // é¡µé¢åŠ è½½æ—¶è¿æ¥
        window.addEventListener('load', () => {
            connectWebSocket();
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (ws) ws.close();
            if (audioContext) audioContext.close();
        });
    </script>
</body>
</html>

